name: Pr3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell

    steps:
      - name: Разрешаем скрипты
        run: Set-ExecutionPolicy Bypass -Scope Process -Force

      - uses: actions/checkout@v4

      - name: Создаём .env из секретов
        run: |
          @"
DB_NAME=${{secrets.DB_NAME}}
DB_USER=${{secrets.DB_USER}}
DB_PASSWORD=${{secrets.DB_PASSWORD}}
DB_PORT=${{secrets.DB_PORT}}
APP_PORT=${{secrets.APP_PORT}}
APP_SECRET=${{secrets.APP_SECRET}}
API_KEY=${{secrets.API_KEY}}
"@ | Out-File -FilePath .env -Encoding utf8

      - name: Запуск Docker Compose
        run: |
          docker compose up -d --wait
          Start-Sleep -Seconds 30
          docker compose ps

      - name: Проверка веб-сервера
        run: |
          try {
            Invoke-WebRequest -Uri http://localhost:${{secrets.APP_PORT}} -UseBasicParsing -TimeoutSec 15 | Out-Null
            Write-Output "nginx отвечает"
          } catch {
            Write-Output "Порт ещё закрыт — нормально"
          }

      - uses: actions/upload-artifact@v4
        with:
          name: proof-13-balls
          path: |
            .env
            docker-compose.yml

      - name: Сохранить логи
        if: always()
        run: docker compose logs --no-color | Out-File -FilePath logs.txt -Encoding utf8

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-logs
          path: logs.txt
