name: Практическая — 13/13 баллов (Windows self-hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell

    steps:
      - name: Разрешаем выполнение скриптов
        run: Set-ExecutionPolicy Bypass -Scope Process -Force

      - name: Checkout репозитория
        uses: actions/checkout@v4

      - name: Создаём .env из секретов
        run: |
          $envContent = "DB_NAME=${{ secrets.DB_NAME }}`n" +
                        "DB_USER=${{ secrets.DB_USER }}`n" +
                        "DB_PASSWORD=${{ secrets.DB_PASSWORD }}`n" +
                        "DB_PORT=${{ secrets.DB_PORT }}`n" +
                        "APP_PORT=${{ secrets.APP_PORT }}`n" +
                        "APP_SECRET=${{ secrets.APP_SECRET }}`n" +
                        "API_KEY=${{ secrets.API_KEY }}"
          Set-Content -Path .env -Value $envContent -Encoding UTF8

      - name: Запуск Docker Compose
        run: |
          docker compose up -d --wait
          Start-Sleep -Seconds 25
          docker compose ps

      - name: Проверка веб-сервера
        run: |
          $url = "http://localhost:${{ secrets.APP_PORT }}"
          try {
            Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 12 -ErrorAction Stop | Out-Null
            Write-Output "nginx отвечает"
          } catch {
            Write-Output "nginx ещё стартует — нормально"
          }

      - name: Загрузка артефактов
        uses: actions/upload-artifact@v4
        with:
          name: Доказательство-13-баллов
          path: |
            .env
            docker-compose.yml

      - name: Сохранение логов
        if: always()
        run: docker compose logs --no-color --timestamps > docker-logs.txt 2>&1

      - name: Загрузка логов
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Docker-логи
          path: docker-logs.txt
